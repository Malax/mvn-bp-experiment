#!/usr/bin/env bash
# bin/release <build-dir>

BUILDPACK_DIR=$(
	cd "$(dirname "${0}")/.." || { echo "Could not determine BUILDPACK_DIR: 'cd' failed!"; exit 1; }
	pwd
)

BUILD_DIR="${1}"

# shellcheck source=lib/dependencies.sh
source "${BUILDPACK_DIR}/lib/dependencies.sh"

echo "---"

if dependencies::app_requires_postgres "${BUILD_DIR}"; then
	cat <<-EOF
	addons:
	  - heroku-postgresql
	EOF
fi

if [[ ! -f "${BUILD_DIR}/Procfile" ]]; then
	jar_files=("${BUILD_DIR}"/target/*.jar)
	jar_file="${jar_files[0]}"

	if [[ -f "${jar_file}" ]]; then
		if dependencies::has_spring_boot "${BUILD_DIR}"; then
			cat <<-EOF
			default_process_types:
			  web: java -Dserver.port=\$PORT \$JAVA_OPTS -jar $jar_file
			EOF
		fi

		if dependencies::has_wildfly_swarm "${BUILD_DIR}"; then
			cat <<-EOF
			default_process_types:
			  web: java -Dswarm.http.port=\$PORT \$JAVA_OPTS -jar $jar_file
			EOF
		fi
	fi
fi
